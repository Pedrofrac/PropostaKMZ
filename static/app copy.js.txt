// static/app.js

/**
 * Função global para ser chamada de outros scripts (como clientes.js).
 * Busca uma proposta por ID, troca para a aba de propostas e preenche o formulário para edição.
 * @param {string} propostaId - O ID da proposta a ser carregada.
 */
async function carregarPropostaParaEdicao(propostaId) {
    try {
        const response = await fetch(`/api/propostas/${propostaId}`);
        if (!response.ok) {
            const err = await response.json();
            throw new Error(err.message || 'Proposta não encontrada.');
        }
        
        const proposta = await response.json();
        
        const tabPropostas = document.getElementById('tab-propostas');
        if (tabPropostas) {
            new bootstrap.Tab(tabPropostas).show();
        }

        preencherFormularioProposta(proposta);
    } catch (error) {
        console.error("Erro ao carregar proposta para edição:", error);
        alert(error.message);
    }
}

/**
 * Função global que preenche o formulário de propostas com os dados de um objeto.
 * @param {object} proposta - O objeto da proposta com todos os seus campos.
 */
function preencherFormularioProposta(proposta) {
    const form = document.getElementById('form-proposta');
    const idInput = document.getElementById('prop-id');
    const btnSalvar = document.getElementById('btn-salvar-proposta');

    form.reset();
    $('#prop-categoria, #prop-fabricante, #prop-modelo, #prop-cor, #prop-pessoa').val(null).trigger('change');
    
    idInput.value = proposta.id;
    document.getElementById('prop-tipo').value = proposta.tipo || '';
    $('#prop-pessoa').val(proposta.pessoa_empresa).trigger('change');
    $('#prop-categoria').val(proposta.categoria).trigger('change');
    $('#prop-cor').val(proposta.cor).trigger('change');
    
    document.getElementById('cambio-automatico').checked = proposta.cambio === 'Automatico';
    document.getElementById('cambio-manual').checked = proposta.cambio === 'Manual';
    
    document.getElementById('prop-ano-min').value = proposta.ano_min || '';
    document.getElementById('prop-ano-max').value = proposta.ano_max || '';
    document.getElementById('prop-preco-min').value = proposta.preco_min || '';
    document.getElementById('prop-preco-max').value = proposta.preco_max || '';
    document.getElementById('prop-obs').value = proposta.observacoes || '';

    const selectModelo = document.getElementById('prop-modelo');
    if (proposta.fabricante) {
        selectModelo.disabled = true;
        $('#prop-fabricante').val(proposta.fabricante).trigger('change');

        setTimeout(() => {
            $('#prop-modelo').val(proposta.modelo).trigger('change');
            selectModelo.disabled = false;
        }, 500);
    }

    btnSalvar.textContent = `Atualizar ID ${proposta.id}`;
    btnSalvar.classList.replace('btn-success', 'btn-primary');
    window.scrollTo(0, 0);
}

/**
 * Função central para renderizar qualquer tabela de propostas no sistema.
 * @param {HTMLElement} tbody - O elemento tbody da tabela a ser preenchido.
 * @param {Array} propostas - A lista de objetos de proposta.
 * @param {boolean} isSuggestion - Se true, não renderiza a coluna de ações de edição/exclusão.
 */
function renderizarTabelaPropostas(tbody, propostas, isSuggestion = false) {
    const colspan = isSuggestion ? 7 : 8;
    tbody.innerHTML = '';
    
    if (!propostas || propostas.length === 0) {
        tbody.innerHTML = `<tr><td colspan="${colspan}" class="text-center">Nenhuma proposta encontrada.</td></tr>`;
        return;
    }

    propostas.forEach(p => {
        const tr = document.createElement('tr');
        tr.dataset.proposta = JSON.stringify(p);
        
        const ano = (p.ano_min && p.ano_max && p.ano_min !== p.ano_max) ? `${p.ano_min}-${p.ano_max}` : (p.ano_min || p.ano_max || '');
        
        let precoExibido = '';
        const precoMinF = p.preco_min ? new Intl.NumberFormat('pt-BR').format(p.preco_min) : '';
        const precoMaxF = p.preco_max ? new Intl.NumberFormat('pt-BR').format(p.preco_max) : '';
        if (precoMinF && precoMaxF) {
            precoExibido = (precoMinF === precoMaxF) ? precoMaxF : `${precoMinF} - ${precoMaxF}`;
        } else {
            precoExibido = precoMinF || precoMaxF;
        }

        const badge = `<span class="badge bg-${p.tipo === 'Compra' ? 'primary' : 'success'} text-capitalize">${p.tipo}</span>`;
        
        let cambioIcon = '';
        if (p.cambio === 'Automatico') {
            cambioIcon = `<i class="bi bi-gear-wide-connected cambio-icon text-muted ms-1" data-bs-toggle="tooltip" title="Automático"></i>`;
        } else if (p.cambio === 'Manual') {
            cambioIcon = `<i class="bi bi-gear cambio-icon text-muted ms-1" data-bs-toggle="tooltip" title="Manual"></i>`;
        }
        
        let corSwatch = '';
        if (p.cor) {
            const corMap = { "BRANCA": "white", "PRETA": "black", "PRATA": "silver", "CINZA": "gray", "VERMELHA": "red", "AZUL": "blue", "VERDE": "green", "AMARELA": "yellow", "MARRON": "saddlebrown", "DOURADA": "gold", "VINHO": "maroon" };
            const corCss = corMap[p.cor.toUpperCase()] || p.cor.toLowerCase();
            const corStyle = `background-color: ${corCss};`;
            corSwatch = `<span class="color-swatch" style="${corStyle}" data-bs-toggle="tooltip" title="${p.cor}"></span>`;
        }
        
        const anunciante = p.pessoa_empresa ? `<span class="text-muted fst-italic">(${p.pessoa_empresa})</span>` : '';
        let veiculoDesc = `${p.fabricante || ''} - ${p.modelo || ''} ${anunciante}${cambioIcon}${corSwatch}`;
        
        let cols = `
            <td class="text-nowrap">${p.id}</td>
            <td class="text-nowrap">${p.data_inclusao}</td>
            <td class="text-nowrap">${badge}</td>
            <td class="text-nowrap">${p.categoria||''}</td>
            <td class="text-nowrap">${veiculoDesc}</td>
            <td class="text-nowrap">${ano}</td>
            <td class="text-nowrap">${precoExibido}</td>
        `;

        if (!isSuggestion) {
            cols += `<td class="text-nowrap">
                        <button class="btn btn-sm btn-warning btn-icon btn-editar-proposta" data-bs-toggle="tooltip" title="Editar">
                            <i class="bi bi-pencil-square"></i>
                        </button> 
                        <button class="btn btn-sm btn-danger btn-icon btn-excluir-proposta" data-id="${p.id}" data-bs-toggle="tooltip" title="Excluir">
                            <i class="bi bi-trash"></i>
                        </button>
                     </td>`;
        } else {
             // Para sugestões, podemos adicionar um botão de visualização se quisermos
            cols += `<td class="text-nowrap">
                        <button class="btn btn-sm btn-primary btn-icon btn-visualizar-proposta" data-id="${p.id}" data-bs-toggle="tooltip" title="Ver/Editar Proposta">
                            <i class="bi bi-eye"></i>
                        </button>
                    </td>`;
        }
        tr.innerHTML = cols;
        tbody.appendChild(tr);
    });
    
    [...tbody.querySelectorAll('[data-bs-toggle="tooltip"]')].map(el => new bootstrap.Tooltip(el));
}


document.addEventListener('DOMContentLoaded', () => {
    // MAPEAMENTO DE ELEMENTOS
    const loginArea = document.getElementById('login-area'), mainContent = document.getElementById('main-content');
    const passwordInput = document.getElementById('password'), loginButton = document.getElementById('login-button');
    const formProposta = document.getElementById('form-proposta'), tbodyPropostas = document.getElementById('resultado-propostas');
    const btnSalvarProposta = document.getElementById('btn-salvar-proposta'), btnLimparFiltros = document.getElementById('btn-limpar-filtros');
    const hotTipsAccordion = document.getElementById('hot-tips-accordion');
    
    $('#prop-categoria, #prop-fabricante, #prop-modelo, #prop-cor, #prop-pessoa').select2({
        theme: 'bootstrap-5'
    });

    // FUNÇÕES
    window.popularSelect = async (selectElement, apiUrl, defaultOptionText) => {
        try {
            const response = await fetch(apiUrl);
            if (!response.ok) throw new Error('API Error');
            const data = await response.json();
            const selectedValue = $(selectElement).val(); 
            selectElement.innerHTML = `<option value="">${defaultOptionText}</option>`;
            data.forEach(item => {
                const option = document.createElement('option');
                option.value = item.nome || item;
                option.textContent = item.nome || item;
                selectElement.appendChild(option);
            });
            $(selectElement).val(selectedValue).trigger('change.select2');
        } catch (error) { console.error(`Erro ao popular select ${selectElement.id}:`, error); }
    };
    
    const limparFormularioProposta = () => {
        formProposta.reset();
        document.getElementById('prop-id').value = '';
        $('#prop-categoria, #prop-fabricante, #prop-modelo, #prop-cor, #prop-pessoa').val(null).trigger('change');
        document.getElementById('prop-modelo').disabled = true;
        btnSalvarProposta.textContent = 'Salvar';
        btnSalvarProposta.classList.replace('btn-primary', 'btn-success');
        dispararPesquisa();
    };

    const dispararPesquisa = async () => {
        tbodyPropostas.innerHTML = `<tr><td colspan="8" class="text-center">Buscando...</td></tr>`;
        hotTipsAccordion.innerHTML = '';
        
        const criterios = {
            tipo: document.getElementById('prop-tipo').value, categoria: $('#prop-categoria').val(), fabricante: $('#prop-fabricante').val(), modelo: $('#prop-modelo').val(),
            ano_min: document.getElementById('prop-ano-min').value, ano_max: document.getElementById('prop-ano-max').value, cor: $('#prop-cor').val(),
            preco_min: document.getElementById('prop-preco-min').value, preco_max: document.getElementById('prop-preco-max').value,
            cambio_automatico: document.getElementById('cambio-automatico').checked, cambio_manual: document.getElementById('cambio-manual').checked,
        };
        try {
            const response = await fetch('/api/propostas/pesquisar', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(criterios) });
            const data = await response.json();
            renderizarTabelaPropostas(tbodyPropostas, data.resultados_principais, false);
            
            if (data.hot_tips && data.hot_tips.length > 0) {
                let accordionHTML = '';
                const cabecalhoTabela = `<thead><tr><th>ID</th><th>Data</th><th>Tipo</th><th>Categoria</th><th>Veículo</th><th>Ano</th><th>Preço</th><th>Ações</th></tr></thead>`;

                data.hot_tips.forEach((tip, index) => {
                    const id = `tip-${index}`;
                    accordionHTML += `<div class="accordion-item">
                                        <h2 class="accordion-header">
                                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-${id}">${tip.titulo}</button>
                                        </h2>
                                        <div id="collapse-${id}" class="accordion-collapse collapse" data-bs-parent="#hot-tips-accordion">
                                            <div class="accordion-body p-2">
                                                <div class="table-responsive">
                                                    <table class="table table-sm table-hover mb-0">
                                                        ${cabecalhoTabela}
                                                        <tbody id="tbody-${id}"></tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                      </div>`;
                });
                hotTipsAccordion.innerHTML = accordionHTML;
                data.hot_tips.forEach((tip, index) => {
                    renderizarTabelaPropostas(document.getElementById(`tbody-tip-${index}`), tip.resultados, true);
                });
            }
        } catch (error) { 
            console.error("Erro na pesquisa:", error);
            tbodyPropostas.innerHTML = `<tr><td colspan="8" class="text-danger text-center">Ocorreu um erro ao buscar os dados.</td></tr>`;
        }
    };
    
    const configurarGatilhosPesquisa = () => {
        document.querySelectorAll('.filtro-auto').forEach(el => {
            if (el.matches('input[type="number"]')) {
                el.addEventListener('keyup', dispararPesquisa);
            } else if (el.matches('input[type="checkbox"]')) {
                el.addEventListener('change', () => {
                    if(el.id === 'cambio-automatico' && el.checked) document.getElementById('cambio-manual').checked = false;
                    if(el.id === 'cambio-manual' && el.checked) document.getElementById('cambio-automatico').checked = false;
                    dispararPesquisa();
                });
            } else { // Selects
                el.addEventListener('change', dispararPesquisa);
            }
        });
        
        $('#prop-fabricante, #prop-modelo, #prop-categoria, #prop-cor').on('select2:select select2:unselect select2:clear', dispararPesquisa);
        
        $('#prop-fabricante').on('change', function () {
            const fab = $(this).val();
            const selectModelo = document.getElementById('prop-modelo');
            
            if (!fab) {
                selectModelo.innerHTML = '<option value="">Escolha um Fabricante</option>';
                selectModelo.disabled = true;
            } else {
                selectModelo.disabled = false;
                popularSelect(selectModelo, `/api/dados/modelos/${fab}`, 'Todos os Modelos');
            }
            $(selectModelo).val(null).trigger('change');
        });
    };

    btnLimparFiltros.addEventListener('click', limparFormularioProposta);

    btnSalvarProposta.addEventListener('click', async () => {
        const proposta = {
            id: document.getElementById('prop-id').value || null,
            tipo: document.getElementById('prop-tipo').value,
            pessoa_empresa: $('#prop-pessoa').val(),
            categoria: $('#prop-categoria').val(),
            fabricante: $('#prop-fabricante').val(),
            modelo: $('#prop-modelo').val(),
            cambio: document.getElementById('cambio-automatico').checked ? 'Automatico' : (document.getElementById('cambio-manual').checked ? 'Manual' : ''),
            ano_min: document.getElementById('prop-ano-min').value,
            ano_max: document.getElementById('prop-ano-max').value,
            preco_min: document.getElementById('prop-preco-min').value,
            preco_max: document.getElementById('prop-preco-max').value,
            cor: $('#prop-cor').val(),
            observacoes: document.getElementById('prop-obs').value
        };
        try {
            const response = await fetch('/api/propostas/salvar', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(proposta) });
            const resultado = await response.json();
            if (!resultado.success) throw new Error(resultado.message);
            alert(resultado.message);
            limparFormularioProposta();
        } catch (error) { alert(`Erro: ${error.message}`); }
    });

    // Listener de eventos unificado para as tabelas de propostas
    document.getElementById('main-content').addEventListener('click', async (e) => {
        const btnEditar = e.target.closest('.btn-editar-proposta');
        const btnExcluir = e.target.closest('.btn-excluir-proposta');
        const btnVisualizar = e.target.closest('.btn-visualizar-proposta');

        if (btnEditar) {
            const proposta = JSON.parse(btnEditar.closest('tr').dataset.proposta);
            preencherFormularioProposta(proposta);
        }
        if (btnExcluir) {
            const id = btnExcluir.dataset.id;
            if (confirm(`Tem certeza que deseja excluir a proposta ID ${id}?`)) {
                try {
                    const response = await fetch(`/api/propostas/excluir/${id}`, { method: 'DELETE' });
                    const resultado = await response.json();
                    if (!resultado.success) throw new Error(resultado.message);
                    alert(resultado.message);
                    dispararPesquisa(); // Atualiza a tabela principal
                } catch (error) { alert(`Erro: ${error.message}`); }
            }
        }
        if(btnVisualizar) {
            const propostaId = btnVisualizar.dataset.id;
            carregarPropostaParaEdicao(propostaId);
        }
    });
    
    loginButton.addEventListener('click', async () => {
        const username = document.getElementById('username').value;
        const password = passwordInput.value;
        try {
            const response = await fetch('/login', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ username, password }) });
            const data = await response.json();
            if (data.success) {
                loginArea.style.display = 'none'; 
                mainContent.style.display = 'block';
                await Promise.all([
                    popularSelect(document.getElementById('prop-fabricante'), '/api/dados/fabricantes', 'Todos'),
                    popularSelect(document.getElementById('prop-categoria'), '/api/dados/categorias', 'Todas'),
                    popularSelect(document.getElementById('prop-cor'), '/api/dados/cores', 'Todas'),
                    popularSelect(document.getElementById('prop-pessoa'), '/api/clientes/listar-nomes', 'Selecione')
                ]);
                configurarGatilhosPesquisa();
                dispararPesquisa();
            } else { 
                document.getElementById('login-message').textContent = data.message;
            }
        } catch (error) { 
            document.getElementById('login-message').textContent = "Erro de conexão com o servidor.";
        }
    });

    passwordInput.addEventListener('keyup', (event) => { if (event.key === "Enter") loginButton.click(); });
});